import streamlit as st
import google.generativeai as genai
import matplotlib.pyplot as plt

# --- CONFIGURACI√ìN DE LA P√ÅGINA ---
st.set_page_config(page_title="Davo Math Academy ‚öΩ", layout="wide")

# El "Cerebro" de Davo: Instrucciones de personalidad
SYSTEM_PROMPT = """
Act√∫a como Davo Xeneize nivel 10 (Termo total). Tu misi√≥n es ense√±ar fracciones a un chico de 13 a√±os.
REGLAS DE ORO:
1. Habl√° como streamer argentino: us√° "boludo", "fiera", "una locura", "par√° un poco".
2. Si el usuario entiende o acierta, escrib√≠ al final: [ESTADO: GOL].
3. Si el usuario falla o dice una burrada, escrib√≠ al final: [ESTADO: ERROR].
4. Siempre que expliques una fracci√≥n, escribila exactamente as√≠: [F: numerador/denominador] para que yo pueda dibujarla.
5. Todo se explica con f√∫tbol: el numerador son los goles, el denominador son los partidos o pedazos de pizza en la previa.
6. No des la respuesta r√°pido, hacelo pensar como si estuviera en una charla t√©cnica.
"""

# --- CONEXI√ìN SEGURA CON LA LLAVE (API KEY) ---
try:
    # Esto busca la llave que pegaste en "Secrets" de Streamlit
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
    model = genai.GenerativeModel('gemini-1.5-flash')
except Exception as e:
    st.error("‚ö†Ô∏è ¬°Falta la API Key! Avisale al Arquitecto que no pusiste la llave en Secrets.")

# --- FUNCI√ìN PARA DIBUJAR LA PIZZA DE FRACCIONES ---
def dibujar_fraccion(n, d):
    fig, ax = plt.subplots(figsize=(3, 3))
    if d <= 0: d = 1 # Evitar errores matem√°ticos
    data = [1] * d
    colors = ['#3b4252'] * d # Color gris (vac√≠o)
    for i in range(min(n, d)):
        colors[i] = '#fbbf24' # Color Oro/Amarillo (ocupado)
    
    ax.pie(data, colors=colors, startangle=90, wedgeprops={"edgecolor":"white"})
    ax.set_title(f"T√°ctica del d√≠a: {n}/{d}", color="white", fontsize=12)
    fig.patch.set_facecolor('#0e1117') # Fondo oscuro como el stream
    return fig

# --- INTERFAZ VISUAL (LO QUE VE EL PIBE) ---
st.title("‚öΩ DAVO XENEIZE: CLASE DE FRACCIONES O MUERTE")
st.write("---")

if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# Dividimos la pantalla en dos: Video/Pizarra y Chat
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("üì∫ Streaming en Vivo")
    
    # L√≥gica para cambiar el GIF de Davo seg√∫n el humor
    imagen_url = "https://media.tenor.com/uR1kS1v-NfQAAAAC/davo-xeneize-davo.gif" # Normal
    if st.session_state.chat_history:
        ultima_respuesta = st.session_state.chat_history[-1]["content"]
        if "[ESTADO: GOL]" in ultima_respuesta:
            imagen_url = "https://media.tenor.com/9O0Z-oV_H0AAAAAd/davo-boca.gif" # Festejo
        elif "[ESTADO: ERROR]" in ultima_respuesta:
            imagen_url = "https://media.tenor.com/F_V9p6fP8m8AAAAC/davo-davo-xeneize.gif" # Enojado
    
    st.image(imagen_url, use_container_width=True)
    
    # Espacio para la pizarra t√°ctica
    st.write("---")
    st.subheader("üìã Pizarra T√°ctica de Rom√°n")
    if st.session_state.chat_history:
        ultima_respuesta = st.session_state.chat_history[-1]["content"]
        if "[F:" in ultima_respuesta:
            try:
                # Extraemos los n√∫meros para dibujar
                parte = ultima_respuesta.split("[F:")[1].split("]")[0].strip()
                num, den = map(int, parte.split("/"))
                st.pyplot(dibujar_fraccion(num, den))
            except:
                st.write("Davo: '¬°No me pidas dibujos raros, flaco!'")

with col2:
    st.subheader("üí¨ Chat con Davo")
    # Mostrar mensajes anteriores
    for mensaje in st.session_state.chat_history:
        with st.chat_message(mensaje["role"]):
            st.markdown(mensaje["content"].replace("[ESTADO: GOL]", "‚öΩüî•").replace("[ESTADO: ERROR]", "ü§å‚ùå"))

    # Entrada de texto para el chico
    if pregunta := st.chat_input("¬øQu√© duda ten√©s, fiera?"):
        st.session_state.chat_history.append({"role": "user", "content": pregunta})
        with st.chat_message("user"):
            st.markdown(pregunta)
        
        # Respuesta de la IA con la personalidad de Davo
        with st.spinner("Davo est√° pensando (y tomando un mate)..."):
            contexto = "\n".join([m["content"] for m in st.session_state.chat_history[-3:]])
            full_input = f"{SYSTEM_PROMPT}\nHistorial reciente: {contexto}\nPregunta actual: {pregunta}"
            
            response = model.generate_content(full_input)
            respuesta_davo = response.text
            
            with st.chat_message("assistant"):
                st.markdown(respuesta_davo.replace("[ESTADO: GOL]", "‚öΩüî•").replace("[ESTADO: ERROR]", "ü§å‚ùå"))
            
            st.session_state.chat_history.append({"role": "assistant", "content": respuesta_davo})
            st.rerun()